## Critical Rendering Path, CRP

다음의 일련의 과정을 `Critical Rendering Path`라고 한다.

- DOM 트리 생성
- CSSOM 트리 생성
- JavaScript 실행
- 렌더 트리 생성
- 레이아웃
- 페인팅

## DOM(Document Object Model)

HTML은 바이트 → 문자 → 토큰 → 노드 → 객체 모델 순서로 변환된다.

- 바이트-문자 변환: 브라우저가 디스크 또는 네트워크에서 HTML의 원시 바이트를 읽고 지정된 파일 인코딩 (예: UTF-8)에 따라 개별 문자로 변환한다.
- 토큰화: 브라우저는 W3C HTML5 표준 및 꺾쇠괄호로 묶인 기타 문자열로 지정된 문자열을 고유한 토큰으로 변환한다.
- 렉싱: 토큰은 해당 속성과 규칙을 정의하는 노드로 변환된다.
- DOM 생성: HTML은 상위-하위 관계로 정의할 수 있어, 트리 구조로 나타낼 수 있습니다. 렉싱 과정을 거쳐 생성된 노드들을 트리 구조로 변환한다.

## CSSOM(CSS Object Model)

DOM과 마찬가지로 CSS는 바이트 → 문자 → 토큰 → 노드 → 객체 모델 순서로 변환된다.

CSSOM이 트리 구조를 사용하는 이유는 페이지에 있는 객체의 최종 스타일 집합을 계산할 때 브라우저는 해당 노드에 적용되는 가장 일반적인 규칙으로 시작하고 계산된 스타일을 재귀적으로 세분화하여 더 구체적인 규칙을 적용하기 때문.

즉, 규칙이 '하향식'으로 적용된다.

## Render-tree

DOM 트리와 CSSOM 트리가 결합되어 렌더 트리를 형성한다.

렌더 트리에는 페이지를 렌더링하는 데 필요한 노드만 포함된다. (e.g. display가 none이면 트리에서 누락된다.)

## Layout

렌더링 트리가 준비되면 '레이아웃' 단계를 진행한다.

기기의 표시 영역 내에서 노드의 정확한 위치와 크기를 계산하는 과정으로 이를 '레이아웃' 단계('리플로우'라고도 함)라고 한다.

## Painting

렌더 트리의 각 노드를 화면의 실제 픽셀로 변환한다. 이 단계를 흔히 '페인팅' 또는 '래스터화'라고 한다.

## JavaScript

JavaScript는 파서를 차단하는 리소스이다.

HTML을 파싱하다가 script 태그를 만나면 DOM 생성을 중지 후 스크립트를 다운로드하고 실행한 다음 다시 DOM을 생성한다.

`async`를 사용하면, 스크립트의 다운로드와 DOM 생성은 동시에 진행되고, 스크립트를 실행할 때만 DOM 생성이 중지된다.

`defer` 또는 `type=module`을 사용하면, 스크립트의 다운로드와 DOM 생성은 동시에 진행되고, 스크립트의 실행은 DOM 생성이 마무리된 이후에 진행된다.

## rel=preload

현재 페이지 렌더링에 필요한 중요한 리소스를 미리 로드하는 방법.

페이지 로드 중 반드시 필요한 리소스를 미리 로드할 때 사용한다.

`background-image: url()`과 같이 프리로드 스캐너에서 발견되지 않는 CSS 프로퍼티에서 사용되는 이미지를 명시하면 성능 향상에 도움이 된다.

## rel=prefetch

현재 페이지에는 필요하지 않지만, 다음에 사용할 가능성이 있는 리소스를 미리 로드하는 방법.

사용자가 다음에 방문할 가능성이 있는 페이지나 리소스를 미리 로드할 때 사용한다.

## rel=dns-prefetch

DNS를 조회하여 IP 주소를 미리 얻도록 하는 방법

리소스 요청 전 DNS 조회 시간 단축할 목적으로 사용한다.

## rel=preconnect

DNS 조회 외에도 TCP 핸드셰이크와 TLS 네고시에이션까지 미리 수행하는 방법

리소스 요청 전 모든 초기 연결 설정 작업 완료할 목적으로 사용한다.

## References

- https://web.dev/articles/critical-rendering-path?hl=ko
