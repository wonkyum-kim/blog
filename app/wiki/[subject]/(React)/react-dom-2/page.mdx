import { CodeSelector } from '@/components/code-selector.tsx'

# ğŸ“ ì‘ì„± ì¤‘...

## react-dom/client

### createRoot

`createRoot`ëŠ” `ReactDOMRoot`ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ë‹¤.

<CodeSelector names={['index.js']} desc='ex1' />

```jsx
import { createRoot } from 'react-dom/client'

// root: ReactDOMRoot
const root = createRoot(document.getElementById('root'))
```

> ì§€ê¸ˆë¶€í„° createRootê°€ ë™ì‘í•˜ëŠ” ê³¼ì •ì„ ì‚´í´ë³¼ ê²ƒì¸ë°, react-reconciler ë¶€ë¶„ì„ ë¨¼ì € ì½ê³  ì˜¤ëŠ” ê²ƒì´ ë„ì›€ì´ ëœë‹¤.

1ë‹¨ê³„: createContainerë¥¼ í˜¸ì¶œí•˜ì—¬ FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.

createContainerëŠ” createFiberRootë¥¼ í˜¸ì¶œí•˜ê³ , createFiberRootëŠ” FiberRootNodeë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•œë‹¤.

FiberRootNodeëŠ” Fiber ê°ì²´ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ê°ì²´ë¼ê³  ìƒê°í•˜ë©´ëœë‹¤.

disableLegacyModeê°€ trueì´ê¸° ë•Œë¬¸ì— Fiber.modeëŠ” ConcurrentModeë¡œ ì„¤ì •ëœë‹¤.

ì‹¤ì œ Fiber ê°ì²´ê°€ ìƒì„±ë˜ëŠ” createFiber ë¶€ë¶„ì€ react-reconcilerë¥¼ ì°¸ê³ í•œë‹¤.

(TODO)ìºì‹œ ê´€ë ¨í•´ì„œëŠ” ì•„ì§ ë¬´ì—‡ì¸ì§€ íŒŒì•…í•˜ì§€ ëª»í–ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ Fiber ê°ì²´ì— update íë¥¼ ì¶”ê°€í•´ì£¼ê³  ë§ˆë¬´ë¦¬ëœë‹¤.

<CodeSelector
  names={['createRoot', 'createContainer', 'createFiberRoot', 'createHostRootFiber']}
  desc='ex2'
/>

```ts {6-11} showLineNumbers
export function createRoot(
  container: Element | Document | DocumentFragment,
  options?: CreateRootOptions
): RootType {
  /* ... */
  // 1ë‹¨ê³„: createContainerë¥¼ í˜¸ì¶œí•˜ì—¬ FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.
  const root = createContainer(
    container,
    ConcurrentRoot
    /* ... */
  )
  /* ... */
}
```

```ts {7-11} showLineNumbers
export function createContainer(
  containerInfo: Container,
  tag: RootTag
  /* ... */
): OpaqueRoot {
  // ...
  return createFiberRoot(
    containerInfo,
    tag
    /* ... */
  )
}
```

```ts {7-12, 16-19, 43-44} showLineNumbers
export function createFiberRoot(
  containerInfo: Container,
  tag: RootTag,
  /* ... */
): FiberRoot {

  // 1. FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.
  const root: FiberRoot = (new FiberRootNode(
    containerInfo,
    tag,
    /* ... */
  ): any);

  /* ... */

  // 2. FiberRootNode.currentì— Fiber ê°ì²´ë¥¼ ë„£ëŠ”ë‹¤.
  const uninitializedFiber = createHostRootFiber(tag, isStrictMode);
  root.current = uninitializedFiber;
  uninitializedFiber.stateNode = root;

  // 3. cache ê´€ë ¨
  if (enableCache) {
    const initialCache = createCache();
    retainCache(initialCache);

    // The pooledCache is a fresh cache instance that is used temporarily
    // for newly mounted boundaries during a render. In general, the
    // pooledCache is always cleared from the root at the end of a render:
    // it is either released when render commits, or moved to an Offscreen
    // component if rendering suspends. Because the lifetime of the pooled
    // cache is distinct from the main memoizedState.cache, it must be
    // retained separately.
    root.pooledCache = initialCache;
    retainCache(initialCache);
    const initialState: RootState = {
      element: initialChildren,
      isDehydrated: hydrate,
      cache: initialCache,
    };
    uninitializedFiber.memoizedState = initialState;
  } else { /* ... */ }

  // 4. Fiber ê°ì²´ì— updateQueueë¥¼ ì¶”ê°€í•œë‹¤.
  initializeUpdateQueue(uninitializedFiber);

  return root;
}
```

```ts {4, 10} showLineNumbers
export function createHostRootFiber(tag: RootTag, isStrictMode: boolean): Fiber {
  let mode
  if (disableLegacyMode || tag === ConcurrentRoot) {
    mode = ConcurrentMode
    /* ... */
  } else {
    mode = NoMode
  }
  /* ... */
  return createFiber(HostRoot, null, null, mode)
}
```

2ë‹¨ê³„: containerì— Fiber ê°ì²´ ì„¤ì •í•˜ê¸°

containerëŠ” createRoot í˜¸ì¶œ ì‹œ ì „ë‹¬í•œ `document.getElementById('root')`ë‹¤.

ì—¬ê¸°ì— Fiber ê°ì²´ë¥¼ ì„¤ì •í•˜ëŠ” ê³¼ì •ì„ ê±°ì¹œë‹¤.

<CodeSelector names={['createRoot', 'markContainerAsRoot']} desc='ex3' />

```ts showLineNumbers {7-8}
export function createRoot(
  container: Element | Document | DocumentFragment,
  options?: CreateRootOptions
): RootType {
  /* ... */
  // 1ë‹¨ê³„: createContainerë¥¼ í˜¸ì¶œí•˜ì—¬ FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.
  // 2ë‹¨ê³„: containerì— Fiber ê°ì²´ ì„¤ì •í•˜ê¸°
  markContainerAsRoot(root.current, container)
}
```

```ts showLineNumbers {3}
export function markContainerAsRoot(hostRoot: Fiber, node: Container): void {
  // $FlowFixMe[prop-missing]
  node[internalContainerInstanceKey] = hostRoot
}
```

3ë‹¨ê³„: ì´ë²¤íŠ¸ ì„¤ì •

listenToAllSupportedEventsë¥¼ ë³´ë©´, containerì— listeningMarkerë¼ëŠ” í•„ë“œë¥¼ ì„¤ì •í•œë‹¤.

ê·¸ë¦¬ê³  selectionchangeë¥¼ ì œì™¸í•œ ëª¨ë“  ë„¤ì´í‹°ë¸Œ ì´ë²¤íŠ¸ì— ëŒ€í•´ì„œ listenToNativeEventë¥¼ í˜¸ì¶œí•œë‹¤.

selectionchangeë¥¼ ì œì™¸í•˜ëŠ” ì´ìœ ëŠ” [ë²„ë¸”ë§ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸](https://developer.mozilla.org/en-US/docs/Web/API/Document/selectionchange_event)ì´ê¸° ë•Œë¬¸ì´ë‹¤.

(ê·¸ë˜ì„œ html DOMì—ë§Œ ì§ì ‘ ì´ë²¤íŠ¸ë¥¼ ì„¤ì •í•œë‹¤. 21 - 26 ë¼ì¸)

ê·¸ë¦¬ê³  ë„¤ì´í‹°ë¸Œ ì´ë²¤íŠ¸ ì¤‘ containerì— ìœ„ì„í•˜ë©´ ì•ˆë˜ëŠ” ê²ƒë“¤ì— ëŒ€í•´ì„œ ë”°ë¡œ ì²˜ë¦¬í•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆëŠ”ë°, ê·¸ ì´ìœ ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ê°€ DOMì—ì„œ ì¼ê´€ë˜ê²Œ ë²„ë¸”ë§ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.

listenToNativeEventëŠ” addTrappedEventListenerë¥¼ í˜¸ì¶œí•œë‹¤.

ì´í›„ ê³¼ì •ì€ ë„ˆë¬´ ë³µì¡í•˜ê³  ë¸Œë¼ìš°ì €ì˜ ìŠ¤í™ì— ë”°ë¼ì„œ ì‘ì„±ëœ ì½”ë“œë¼ì„œ ë¶„ì„í•˜ê¸°ê°€ ì–´ë ¤ì› ë‹¤.

ê·¸ë˜ë„ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´, ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸ë“¤ì´ ìš°ì„ ìˆœìœ„(FiberLane)ì— ë”°ë¼ì„œ ì‹¤í–‰ë˜ë„ë¡ í•˜ê³ , containerì— íŠ¹ì • ì´ë²¤íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì„ addEventListenrë¡œ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ì»´í¬ë„ŒíŠ¸ì— onClickì„ í• ë‹¹í–ˆì„ ë•Œ, ê°œë°œìê°€ í• ë‹¹í•œ í•¸ë“¤ëŸ¬ ë§ê³ ë„ ë¦¬ì•¡íŠ¸ì—ì„œ ë¯¸ë¦¬ í• ë‹¹ëœ ìˆ¨ê²¨ì§„ í•¸ë“¤ëŸ¬ê°€ ë¨¼ì € ì‘ë™ë˜ê³  ìˆì—ˆë‹¤ëŠ” ê²ƒì´ë‹¤.

<CodeSelector
  names={['createRoot', 'listenToAllSupportedEvents', 'listenToNativeEvent']}
  desc='ex4'
/>

```ts showLineNumbers {8-13}
export function createRoot(
  container: Element | Document | DocumentFragment,
  options?: CreateRootOptions
): RootType {
  /* ... */
  // 1ë‹¨ê³„: createContainerë¥¼ í˜¸ì¶œí•˜ì—¬ FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.
  // 2ë‹¨ê³„: containerì— Fiber ê°ì²´ ì„¤ì •í•˜ê¸°
  // 3ë‹¨ê³„: ì´ë²¤íŠ¸ ì„¤ì •
  const rootContainerElement: Document | Element | DocumentFragment =
    container.nodeType === COMMENT_NODE
      ? (container.parentNode: any)
      : container;
  listenToAllSupportedEvents(rootContainerElement);
}
```

```ts showLineNumbers {5, 9-14, 21-26}
const listeningMarker = '_reactListening' + Math.random().toString(36).slice(2);

export function listenToAllSupportedEvents(rootContainerElement: EventTarget) {
  if (!(rootContainerElement: any)[listeningMarker]) {
    (rootContainerElement: any)[listeningMarker] = true;
    allNativeEvents.forEach(domEventName => {
      // We handle selectionchange separately because it
      // doesn't bubble and needs to be on the document.
      if (domEventName !== 'selectionchange') {
        if (!nonDelegatedEvents.has(domEventName)) {
          listenToNativeEvent(domEventName, false, rootContainerElement);
        }
        listenToNativeEvent(domEventName, true, rootContainerElement);
      }
    });
    const ownerDocument =
      (rootContainerElement: any).nodeType === DOCUMENT_NODE
        ? rootContainerElement
        : (rootContainerElement: any).ownerDocument;
    if (ownerDocument !== null) {
      // The selectionchange event also needs deduplication
      // but it is attached to the document.
      if (!(ownerDocument: any)[listeningMarker]) {
        (ownerDocument: any)[listeningMarker] = true;
        listenToNativeEvent('selectionchange', false, ownerDocument);
      }
    }
  }
}
```

```ts showLineNumbers {10}
export function listenToNativeEvent(
  domEventName: DOMEventName,
  isCapturePhaseListener: boolean,
  target: EventTarget
): void {
  let eventSystemFlags = 0
  if (isCapturePhaseListener) {
    eventSystemFlags |= IS_CAPTURE_PHASE
  }
  addTrappedEventListener(target, domEventName, eventSystemFlags, isCapturePhaseListener)
}
```

4ë‹¨ê³„: ReactDOMRoot ë°˜í™˜

FiberRootNodeë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ReactDOMRoot ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•œë‹¤.

ì¦‰ ë‹¤ìŒê³¼ ê°™ì€ í¬í•¨ê´€ê³„ê°€ í˜•ì„±ëœ ê²ƒì´ë‹¤.

ReactDOMRoot \< FiberRootNode \< Fiber

ReactDOMRootì—ëŠ” renderì™€ unmount ë©”ì„œë“œê°€ ì¶”ê°€ë˜ëŠ”ë°, ì´ê²ƒì€ ë°‘ì—ì„œ ì‚´í´ë³´ê¸°ë¡œ í•œë‹¤.

<CodeSelector names={['createRoot', 'ReactDOMRoot']} desc='ex5' />

```ts showLineNumbers {9-10}
export function createRoot(
  container: Element | Document | DocumentFragment,
  options?: CreateRootOptions
): RootType {
  /* ... */
  // 1ë‹¨ê³„: createContainerë¥¼ í˜¸ì¶œí•˜ì—¬ FiberRootNodeë¥¼ ìƒì„±í•œë‹¤.
  // 2ë‹¨ê³„: containerì— Fiber ê°ì²´ ì„¤ì •í•˜ê¸°
  // 3ë‹¨ê³„: ì´ë²¤íŠ¸ ì„¤ì •
  // 4ë‹¨ê³„: ReactDOMRoot ë°˜í™˜
  return new ReactDOMRoot(root)
}
```

```ts showLineNumbers {2}
function ReactDOMRoot(internalRoot: FiberRoot) {
  this._internalRoot = internalRoot
}
```

### ReactDOMRoot.render

createRootê°€ ë°˜í™˜í•œ ê°ì²´ì˜ render ë©”ì„œë“œì— ëŒ€í•´ì„œ ì‚´í´ë³¸ë‹¤.

TODO

### ReactDOMRoot.unmount

TODO

### hydrateRoot

TODO
