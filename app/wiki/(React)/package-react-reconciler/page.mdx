import { CodeSelector } from '@/components/code-selector.tsx'

# ğŸ“ ì‘ì„± ì¤‘...

## react-reconciler íŒ¨í‚¤ì§€

TODO

## Renderì™€ Commit

TODO

## Fiber Tree

`Fiber`ëŠ” ì²˜ë¦¬ ë˜ì–´ì•¼ í•˜ê±°ë‚˜ ì²˜ë¦¬ ëœ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì‘ì—…ì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ë¡œ, ë‹¨ì¼ ì—°ê²° ë¦¬ìŠ¤íŠ¸ë¥¼ í†µí•´ íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ì´ë£¨ê³  ìˆë‹¤.

Fiber íŠ¸ë¦¬ëŠ” í˜„ì¬ ëª¨ìŠµì„ ë‚˜íƒ€ë‚´ëŠ” `current`ì™€ ì‘ì—… ì¤‘ì¸ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” `workInProgress`ê°€ ìˆë‹¤.

ë”°ë¼ì„œ ì»´í¬ë„ŒíŠ¸ í•˜ë‚˜ë‹¹ í•˜ë‚˜ ì´ìƒì˜ Fiber ê°ì²´ê°€ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤.

ReactëŠ” currentë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì—…ì„ í•˜ì—¬ ìƒˆë¡œìš´ workInProgress íŠ¸ë¦¬ë¥¼ ë§Œë“¤ê³  currentë¥¼ workInProgressë¡œ êµì²´í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.

## createFiber

Fiber ê°ì²´ëŠ” `createFiber`ë¥¼ í†µí•´ ìƒì„±ë˜ë©° ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ëœë‹¤.

| key           | value                                                                                                    |
| ------------- | -------------------------------------------------------------------------------------------------------- |
| tag           | Fiberì˜ íƒ€ì…ì„ ì‹ë³„í•˜ëŠ” íƒœê·¸. 0ë¶€í„° 29ê¹Œì§€ì˜ ìˆ«ìê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìœ¼ë©° ReactWorkTag.jsì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. |
| key           | Fiber childì˜ ê³ ìœ  ì‹ë³„ìë¡œ null ë˜ëŠ” ë¬¸ìì—´ì´ë‹¤.                                                        |
| elementType   | element.typeì˜ ê°’ìœ¼ë¡œ Fiber childì˜ ì¬ì¡°ì • ë™ì•ˆì— ì‹ë³„í•˜ëŠ” ê²ƒì„ ìœ ì§€í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤.                     |
| type          | ì´ Fiberì™€ ì—°ê´€ë˜ì–´ ìˆëŠ” resolvedëœ í•¨ìˆ˜ ë˜ëŠ” í´ë˜ìŠ¤                                                     |
| stateNode     | ì´ Fiberì™€ ì—°ê´€ë˜ì–´ ìˆëŠ” local state                                                                     |
| return        | ë¶€ëª¨ Fiber                                                                                               |
| child         | ì²« ë²ˆì§¸ ìì‹ Fiber. ìì‹ì´ ì—¬ëŸ¬ ê°œì´ë©´, indexë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.                                          |
| sibling       | ë‹¤ìŒ í˜•ì œ Fiber.                                                                                         |
| index         | ì—¬ëŸ¬ í˜•ì œë“¤ ì‚¬ì´ì—ì„œ ìì‹ ì´ ëª‡ ë²ˆì§¸ ìì‹ì¸ì§€ ë‚˜íƒ€ë‚¸ë‹¤.                                                   |
| ref           |                                                                                                          |
| refCleanup    |                                                                                                          |
| pendingProps  | ì•„ì§ ì‘ì—…ì´ ì²˜ë¦¬ë˜ì§€ ì•Šì€ props                                                                          |
| memoizedProps | ë Œë”ë§ì´ ì™„ë£Œëœ í›„ pendingPropsë¥¼ ì €ì¥í•œë‹¤.                                                              |
| updateQueue   | ìƒíƒœ ì—…ë°ì´íŠ¸ì™€ ì½œë°± í•¨ìˆ˜ë“¤ì„ ì €ì¥í•˜ëŠ” í                                                                |
| memoizedState | í˜„ì¬ Fiberì˜ í›…ì´ ë§í¬ë“œ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì €ì¥ë˜ì–´ ìˆë‹¤.                                                    |
| dependencies  | ì´ Fiberì˜ ë””íœë˜ì‹œ(contexts, events)                                                                    |
| mode          | Fiberì™€ ê·¸ ì„œë¸ŒíŠ¸ë¦¬ì˜ í”„ë¡œí¼í‹°ë“¤ì„ ì„¤ëª…í•˜ëŠ” ë¹„íŠ¸í•„ë“œ. ReactTypeofMode.jsì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.             |
| flags         | ì—…ë°ì´íŠ¸, í´ë¡  ë“± ë‹¤ì–‘í•œ ìƒí™©ì— ëŒ€í•œ í”Œë˜ê·¸. ReactFiberFlags.jsì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.                      |
| subtreeFlags  |                                                                                                          |
| deletions     | ì‚­ì œëœ Fiber ë°°ì—´                                                                                        |
| lanes         | ì‘ì—…ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ê´€ë¦¬í•œë‹¤. ReactFiberLane.jsì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.                                        |
| childLanes    |                                                                                                          |
| alternate     | ë°˜ëŒ€í¸ Fiber íŠ¸ë¦¬ë¥¼ ê°€ë¦¬í‚¨ë‹¤.                                                                            |

## renderWithHooks

react-reconciler/src/ReactFiberHooks.jsì— ìˆëŠ” `renderWithHooks` í•¨ìˆ˜ëŠ” ReactSharedInternals.Hì— ëª¨ë“  React í›…ì„ í• ë‹¹í•œë‹¤.

ì´ë•Œ, í˜„ì¬ fiberê°ì²´(current)ì— í•´ë‹¹í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ì§€ ì•„ë‹ˆë©´ ì—…ë°ì´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ì§€ì— ë”°ë¼ì„œ _ë‹¤ë¥¸ í›…ì„ í• ë‹¹í•´ì¤€ë‹¤._

ê·¸ë¦¬ê³  ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ ë Œë” í˜ì´ì¦ˆê°€ ìŠ¤ì¼€ì¤„ë§ ë˜ì—ˆë‹¤ë©´(= ì¬ë Œë”ë§ì´ ë°œìƒí–ˆë‹¤ë©´), ëë‚´ì§€ ë§ê³  `renderWithHooksAgain`ì„ í˜¸ì¶œí•˜ì—¬ í•œêº¼ë²ˆì— ì²˜ë¦¬í•˜ë„ë¡ í•œë‹¤. (ì˜ˆë¥¼ ë“¤ì–´ setStateê°€ ë Œë”ë§ ì¤‘ì— í˜¸ì¶œë˜ì—ˆë‹¤ê³  ìƒê°í•´ë³´ì.)

ì´ë•Œ ì¬ë Œë”ë§ì˜ íšŸìˆ˜ê°€ 25ë²ˆì„ ë„˜ì–´ê°€ë©´ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

`finishRenderingHooks`ì—ì„œëŠ” ë Œë” í˜ì´ì¦ˆë¥¼ ë§ˆë¬´ë¦¬í•˜ê³  ì´ˆê¸°í™”í•œë‹¤.

<CodeSelector names={['renderWithHooks', 'renderWithHooksAgain']} desc='ex2' />

```ts showLineNumbers {12-13, 22}
export function renderWithHooks<Props, SecondArg>(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes
): any {
  // ...
  ReactSharedInternals.H =
    current === null || current.memoizedState === null
      ? HooksDispatcherOnMount
      : HooksDispatcherOnUpdate
  // ...
  let children = __DEV__
    ? callComponentInDEV(Component, props, secondArg)
    : Component(props, secondArg)
  // ...
  if (didScheduleRenderPhaseUpdateDuringThisPass) {
    // Keep rendering until the component stabilizes (there are no more render
    // phase updates).
    children = renderWithHooksAgain(workInProgress, Component, props, secondArg)
  }
  // ...
  finishRenderingHooks(current, workInProgress, Component)

  return children
}
```

```ts showLineNumbers {11-15}
function renderWithHooksAgain<Props, SecondArg>(
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg
): any {
  let numberOfReRenders: number = 0
  let children
  do {
    // ...
    if (numberOfReRenders >= RE_RENDER_LIMIT) {
      throw new Error(
        'Too many re-renders. React limits the number of renders to prevent ' + 'an infinite loop.'
      )
    }

    numberOfReRenders += 1
    // ...

    ReactSharedInternals.H = __DEV__ ? HooksDispatcherOnRerenderInDEV : HooksDispatcherOnRerender

    children = __DEV__
      ? callComponentInDEV(Component, props, secondArg)
      : Component(props, secondArg)
  } while (didScheduleRenderPhaseUpdateDuringThisPass)
  return children
}
```
