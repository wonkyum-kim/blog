import { CodeSelector } from '@/components/code-selector.tsx'

# ğŸ“ ì‘ì„± ì¤‘...

## react-reconciler íŒ¨í‚¤ì§€

TODO

- React í›…ì˜ êµ¬í˜„ì´ ìˆìœ¼ë©° ReactSharedInternalsì— ì£¼ì…í•œë‹¤.

## Fiber

`Fiber`ëŠ” ì²˜ë¦¬ ë˜ì–´ì•¼ í•˜ê±°ë‚˜ ì²˜ë¦¬ ëœ ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì‘ì—…ì´ë‹¤.

ì»´í¬ë„ŒíŠ¸ í•˜ë‚˜ë‹¹ í•˜ë‚˜ ì´ìƒì˜ Fiber ê°ì²´ê°€ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤.

fiber ê°ì²´ëŠ” `createFiber`ë¥¼ í†µí•´ ìƒì„±ë˜ë©° ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ëœë‹¤.

<CodeSelector names={['react-reconciler/src/ReactFiber.js']} desc='ex1' />

```ts showLineNumbers
const fiber: Fiber = {
  // Instance
  // tag, key - defined at the bottom as dynamic properties
  elementType: null, // ì¬ì¡°ì • ì¤‘ì— identityë¥¼ ìœ ì§€í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” element.typeì˜ ê°’
  type: null, // ì´ fiberì™€ ì—°ê´€ëœ resolvedëœ function or class
  stateNode: null, // ì´ fiberì™€ ì—°ê´€ëœ local state

  // Fiber
  return: null, // ì‘ì—…ì„ ë§ˆë¬´ë¦¬í•˜ê³  ë°˜í™˜í•˜ëŠ” fiber. ë¶€ëª¨ fiberì™€ ê°™ë‹¤.
  // ë‹¨ì¼ ì—°ê²° ë¦¬ìŠ¤íŠ¸ íŠ¸ë¦¬ êµ¬ì¡°ì™€ ê°™ë‹¤.
  child: null,
  sibling: null,
  index: 0,

  ref: null, // ì´ ë…¸ë“œì— ë¶€ì°©ëœ ref
  refCleanup: null,

  // pendingProps - defined at the bottom as dynamic properties
  memoizedProps: null, // ouputì„ ë§Œë“œëŠ”ë° ì‚¬ìš©ëœ props
  updateQueue: null, // ìƒíƒœ ì—…ë°ì´íŠ¸ì™€ ì½œë°±ë“¤ì„ ì €ì¥í•˜ëŠ” í
  memoizedState: null, // outputì„ ë§Œë“œëŠ”ë° ì‚¬ìš©ëœ ìƒíƒœ
  dependencies: null, // context, events...

  // Effects
  flags: NoFlags,
  subtreeFlags: NoFlags,
  deletions: null,

  lanes: NoLanes,
  childLanes: NoLanes,

  // Fiberì˜ í’€ë§ë²„ì „.
  // ì—…ë°ì´íŠ¸ëœ ëª¨ë“  fiberëŠ” ê²°êµ­ í•œ ìŒì„ ê°€ì§„ë‹¤.
  alternate: null,

  // dynamic properties at the end for more efficient hermes bytecode
  tag, // fiberì˜ íƒ€ì…ì„ í™•ì¸í•˜ëŠ” íƒœê·¸
  key, // ê³ ìœ  ì‹ë³„ì
  pendingProps, // input props
  // fiberì™€ ê·¸ ì„œë¸ŒíŠ¸ë¦¬ì˜ í”„ë¡œí¼í‹°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë¹„íŠ¸í•„ë“œ.
  // E.g. ConcurrentMode flagëŠ” ì„œë¸ŒíŠ¸ë¦¬ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ë™ê¸°ì„ì„ ë‚˜íƒ€ë‚¸ë‹¤.
  // fiberê°€ ìƒì„±ë˜ë©´, ë¶€ëª¨ì˜ modeë¥¼ ìƒì†ë°›ëŠ”ë‹¤.
  // ì¶”ê°€ì ì¸ flagëŠ” ìƒì„± ì‹œê°„ì— ì„¤ì •ë˜ê³ , fiberì˜ ë¼ì´í”„ íƒ€ì„ë™ì•ˆ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.
  mode,
}
```

## renderWithHooks

react-reconciler/src/ReactFiberHooks.jsì— ìˆëŠ” `renderWithHooks` í•¨ìˆ˜ëŠ” ReactSharedInternals.Hì— React í›…ì„ í• ë‹¹í•œë‹¤.

ì´ë•Œ, í˜„ì¬ fiberê°ì²´(current)ì— í•´ë‹¹í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ì§€ ì•„ë‹ˆë©´ ì—…ë°ì´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ì§€ì— ë”°ë¼ì„œ ë‹¤ë¥¸ í›…ì„ í• ë‹¹í•´ì¤€ë‹¤.

<CodeSelector names={['renderWithHooks', 'useState']} desc='ex2' />

```ts showLineNumbers {12-13}
export function renderWithHooks<Props, SecondArg>(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes
): any {
  // ...
  ReactSharedInternals.H =
    current === null || current.memoizedState === null
      ? HooksDispatcherOnMount
      : HooksDispatcherOnUpdate
  // ...
  let children = __DEV__
    ? callComponentInDEV(Component, props, secondArg)
    : Component(props, secondArg)
  // ...
  finishRenderingHooks(current, workInProgress, Component)

  return children
}
```

```ts showLineNumbers
// ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ ë  ë•Œ ì‚¬ìš©ë˜ëŠ” useState
function mountState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  const hook = mountStateImpl(initialState);
  const queue = hook.queue;
  const dispatch: Dispatch<BasicStateAction<S>> = (dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any);
  queue.dispatch = dispatch;
  return [hook.memoizedState, dispatch];
}

// ì»´í¬ë„ŒíŠ¸ê°€ ì—…ë°ì´íŠ¸ ë  ë•Œ ì‚¬ìš©ë˜ëŠ” useState
function updateState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  return updateReducer(basicStateReducer, initialState);
}
```

`finishRenderingHooks`ì—ì„œëŠ” ë Œë” í˜ì´ì¦ˆë¥¼ ë§ˆë¬´ë¦¬í•˜ê³  ì •ë¦¬í•œë‹¤.

TODO: enableLazyContextPropagation
