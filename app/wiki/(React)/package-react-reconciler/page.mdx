import { CodeSelector } from '@/components/code-selector.tsx'

# 📝 작성 중...

## react-reconciler 패키지

TODO

## Render와 Commit

TODO

## Fiber Tree

`Fiber`는 처리 되어야 하거나 처리 된 컴포넌트에 대한 작업을 나타내는 객체로, 단일 연결 리스트를 통해 트리 구조를 이루고 있다.

Fiber 트리는 현재 모습을 나타내는 `current`와 작업 중인 상태를 나타내는 `workInProgress`가 있다.

따라서 컴포넌트 하나당 하나 이상의 Fiber 객체가 존재할 수 있다.

React는 current를 기준으로 작업을 하여 새로운 workInProgress 트리를 만들고 current를 workInProgress로 교체하는 방법을 사용한다.

## createFiber

Fiber 객체는 `createFiber`를 통해 생성되며 아래와 같이 구성된다.

| key           | value                                                                                                    |
| ------------- | -------------------------------------------------------------------------------------------------------- |
| tag           | Fiber의 타입을 식별하는 태그. 0부터 29까지의 숫자가 들어갈 수 있으며 ReactWorkTag.js에서 확인할 수 있다. |
| key           | Fiber child의 고유 식별자로 null 또는 문자열이다.                                                        |
| elementType   | element.type의 값으로 Fiber child의 재조정 동안에 식별하는 것을 유지하는데 사용된다.                     |
| type          | 이 Fiber와 연관되어 있는 resolved된 함수 또는 클래스                                                     |
| stateNode     | 이 Fiber와 연관되어 있는 local state                                                                     |
| return        | 부모 Fiber                                                                                               |
| child         | 첫 번째 자식 Fiber. 자식이 여러 개이면, index로 구분할 수 있다.                                          |
| sibling       | 다음 형제 Fiber.                                                                                         |
| index         | 여러 형제들 사이에서 자신이 몇 번째 자식인지 나타낸다.                                                   |
| ref           |                                                                                                          |
| refCleanup    |                                                                                                          |
| pendingProps  | 아직 작업이 처리되지 않은 props                                                                          |
| memoizedProps | 렌더링이 완료된 후 pendingProps를 저장한다.                                                              |
| updateQueue   | 상태 업데이트와 콜백 함수들을 저장하는 큐                                                                |
| memoizedState | 현재 Fiber의 훅이 링크드 리스트 형태로 저장되어 있다.                                                    |
| dependencies  | 이 Fiber의 디펜던시(contexts, events)                                                                    |
| mode          | Fiber와 그 서브트리의 프로퍼티들을 설명하는 비트필드. ReactTypeofMode.js에서 확인할 수 있다.             |
| flags         | 업데이트, 클론 등 다양한 상황에 대한 플래그. ReactFiberFlags.js에서 확인할 수 있다.                      |
| subtreeFlags  |                                                                                                          |
| deletions     | 삭제된 Fiber 배열                                                                                        |
| lanes         | 작업의 우선순위를 관리한다. ReactFiberLane.js에서 확인할 수 있다.                                        |
| childLanes    |                                                                                                          |
| alternate     | 반대편 Fiber 트리를 가리킨다.                                                                            |

## renderWithHooks

react-reconciler/src/ReactFiberHooks.js에 있는 `renderWithHooks` 함수는 ReactSharedInternals.H에 모든 React 훅을 할당한다.

이때, 현재 fiber객체(current)에 해당하는 컴포넌트가 마운트되어야 하는지 아니면 업데이트되어야 하는지에 따라서 _다른 훅을 할당해준다._

그리고 이 함수가 실행되는 동안 다른 렌더 페이즈가 스케줄링 되었다면(= 재렌더링이 발생했다면), 끝내지 말고 `renderWithHooksAgain`을 호출하여 한꺼번에 처리하도록 한다. (예를 들어 setState가 렌더링 중에 호출되었다고 생각해보자.)

이때 재렌더링의 횟수가 25번을 넘어가면 에러가 발생한다.

`finishRenderingHooks`에서는 렌더 페이즈를 마무리하고 초기화한다.

<CodeSelector names={['renderWithHooks', 'renderWithHooksAgain']} desc='ex2' />

```ts showLineNumbers {12-13, 22}
export function renderWithHooks<Props, SecondArg>(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes
): any {
  // ...
  ReactSharedInternals.H =
    current === null || current.memoizedState === null
      ? HooksDispatcherOnMount
      : HooksDispatcherOnUpdate
  // ...
  let children = __DEV__
    ? callComponentInDEV(Component, props, secondArg)
    : Component(props, secondArg)
  // ...
  if (didScheduleRenderPhaseUpdateDuringThisPass) {
    // Keep rendering until the component stabilizes (there are no more render
    // phase updates).
    children = renderWithHooksAgain(workInProgress, Component, props, secondArg)
  }
  // ...
  finishRenderingHooks(current, workInProgress, Component)

  return children
}
```

```ts showLineNumbers {11-15}
function renderWithHooksAgain<Props, SecondArg>(
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg
): any {
  let numberOfReRenders: number = 0
  let children
  do {
    // ...
    if (numberOfReRenders >= RE_RENDER_LIMIT) {
      throw new Error(
        'Too many re-renders. React limits the number of renders to prevent ' + 'an infinite loop.'
      )
    }

    numberOfReRenders += 1
    // ...

    ReactSharedInternals.H = __DEV__ ? HooksDispatcherOnRerenderInDEV : HooksDispatcherOnRerender

    children = __DEV__
      ? callComponentInDEV(Component, props, secondArg)
      : Component(props, secondArg)
  } while (didScheduleRenderPhaseUpdateDuringThisPass)
  return children
}
```
